\documentclass[a4paper,11pt]{scrreprt}
\usepackage{scrhack} % eliminates warning generated by combining scrreprt and listings
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{listings}
\usepackage[noadjust]{marginnote}
\usepackage{lmodern}
\usepackage{beramono}
\usepackage{fixltx2e,microtype,ellipsis,ragged2e}
\usepackage{graphicx}
\usepackage{pifont}
\usepackage[scale=0.8]{geometry}
\usepackage{color}
\usepackage{MnSymbol}
\usepackage{relsize}

\reversemarginpar

\definecolor{commentColor}{rgb}{0,0.6,0}
\definecolor{stringColor}{rgb}{0.58,0,0.82}

\lstset{%
    basicstyle=\ttfamily\footnotesize,%
    breaklines=true,%
    breakatwhitespace=true,%
    postbreak=\raisebox{0ex}[0ex][0ex]{\ensuremath{\rcurvearrowse\space}},%
    commentstyle=\color{commentColor},%
    keywordstyle=\bfseries\color{blue},%
    stringstyle=\color{stringColor}%
}
\lstloadlanguages{[11]C++,[5.2]Lua}

\def\ifmonospace{\ifdim\fontdimen3\font=0pt}
\def\Cpp{%
\ifmonospace%
    C++%
\else%
    \mbox{C\kern-.1667em\raise.30ex\hbox{\smaller{++}}}%
\fi%
\xspace}

\lstnewenvironment{cpp}
{\lstset{language={[11]C++},title=\Cpp}}
{}

\lstnewenvironment{cppBox}[1][]
{\noindent\minipage[t]{0.48\linewidth}%
\lstset{language={[11]C++},title=\Cpp,#1}}
{\endminipage}

\lstnewenvironment{lua}
{\lstset{language={[5.2]Lua},title=Lua}}
{}

\lstnewenvironment{luaBox}[1][]
{\noindent\minipage[t]{0.48\linewidth}%
\lstset{language={[5.2]Lua},title=Lua,#1}}
{\endminipage}

\newcommand{\marginMarker}[1]{%
\marginnote{%
    \hfill%
		\Huge{#1}%
}[3\baselineskip]%
}

\newcommand{\conforming}{%
\marginMarker{\textcolor{green}{\ding{51}}}%
}

\newcommand{\nonconforming}{%
\marginMarker{\textcolor{red}{\ding{55}}}%
}

\begin{document}
\title{Illarion Coding Style\\0.0}
\author{vilarion \thanks{ \texttt{vilarion@illarion.org, http://www.illarion.org}}}
\date{2014}
\maketitle
\tableofcontents

\chapter{Introduction}
The team of Illarion developers has grown over time. And while everyone has their preferred coding style, it is useful to agree on a single one. This makes it easier for others to read your code, understand and modify it. These rules do not only cover the appearance of code, but also how the coding itself is performed, which functionality to use or avoid and best practices. The purpose of this document is not to hamper you in your coding efforts with an overly exhaustive set of rules, but to guide you towards clean code for the benefit of all.

There are many languages involved in Illarion development. They range from mark-up languages like HTML or the typesetting language \LaTeX\ to a whole array of different programming languages like \Cpp, Java, Lua, PHP or GLSL. Examples given, either conforming or non-conforming, will be in \Cpp and Lua. You can easily derive how they would look like in the language you are currently using. Rules are designed to be as general as possible to apply to most languages used in Illarion development.

Examples are tagged with icons to annotate whether or not they are conforming. Non-conforming examples are designed such, that only the current issue is being violated. They are correct in every other aspect, so that you can focus on the issue at hand.

This is what correct examples look like:

\conforming{}
\begin{cppBox}
for (auto &item: items) {
    item.age();
}
\end{cppBox}
\begin{luaBox}
for _, item in pairs(items) do
    item.age()
end
\end{luaBox}

A violating example looks like this:

\nonconforming{}
\begin{cppBox}
for (auto &item: items)
{
    item.age();
}
\end{cppBox}
\begin{luaBox}
for _, item in pairs(items)
do
    item.age()
end
\end{luaBox}

\chapter{Appearance}
\section{Write lines not longer than 120 characters}
Long lines of code tend to get difficult to read. If your lines get longer than 120 characters, reconsider what you are writing. In fact, most statements should fit into a line of 80 characters. Maybe there is a better way to express what you want to do. If you still need longer lines, break them up, indenting them further than the next statement.

This rule does not apply to continuous text e.g. in HTML. Breaking up continuous text can lead to strange diffs where changing a single word could put a whole paragraph into the diff.

\section{Write one statement per line}
On the other hand, do not cram statements into one line until it reaches its length limit. One statement per line allows for good readability. Compare:

\nonconforming{}
\begin{cppBox}
auto strength = 10; auto wisdom = 8;
\end{cppBox}
\begin{luaBox}
local strength = 10 local wisdom = 8
\end{luaBox}

\conforming{}
\begin{cppBox}
auto strength = 10;
auto wisdom = 8;
\end{cppBox}
\begin{luaBox}
local strength = 10
local wisdom = 8
\end{luaBox}

\section{Frame code blocks with one line on each end}
Each local code block should be framed by one line on each end:

\conforming{}
\begin{cppBox}
for (auto &item: items) {
    item.age();
}
\end{cppBox}
\begin{luaBox}
for _, item in pairs(items) do
    item.age()
end
\end{luaBox}

\nonconforming{}
\begin{cppBox}
for (auto &item: items)
{
    item.age();
}
\end{cppBox}
\begin{luaBox}
for _, item in pairs(items)
do
    item.age()
end
\end{luaBox}

\section{Seperate adjacent code blocks with an empty line}
You can also use an empty line to structure logical groups.

\conforming{}
\begin{cppBox}
auto minutes = 3;
auto seconds = minutes * 60;

for (auto &item: items) {
    for (auto i = 0; i < 5; ++i) {
        item.age(seconds);
    }
}
\end{cppBox}
\begin{luaBox}
local minutes = 3
local seconds = minutes * 60

for _, item in pairs(items) do
    for i = 1, 5 do
        item.age(seconds)
    end
end
\end{luaBox}

\nonconforming{}
\begin{cppBox}
auto minutes = 3;
auto seconds = minutes * 60;
for (auto &item: items) {

    for (auto i = 0; i < 5; ++i) {
        item.age(seconds);
    }
}
\end{cppBox}
\begin{luaBox}
local minutes = 3

local seconds = minutes * 60
for _, item in pairs(items) do
    for i = 1, 5 do
        item.age(seconds)
    end
end
\end{luaBox}

\section{Space}
\subsection{Indent four spaces inside code blocks}
Local code blocks have to be indented by four spaces. Do not use tabulators.

\conforming{}
\begin{cppBox}[showspaces]
{
    auto result = database.query();
    result.validate();
}
\end{cppBox}
\begin{luaBox}[showspaces]
do
    local npc = getNPC()
    npc:talk("Hello!")
end
\end{luaBox}

\subsection{Use space after a delimiter}
Each delimiting character has to be followed by exactly one space:

\conforming{}
\begin{cppBox}[showspaces]
for (const auto number: {42, 0, 1}) {
    cout << number;
}
\end{cppBox}
\begin{luaBox}[showspaces]
for number in {1, 2, 3} do
    print(number)
end
\end{luaBox}

\nonconforming{}
\begin{cppBox}[showspaces]
for (const auto number:{42, 0, 1}) {
    cout << number;
}
\end{cppBox}
\begin{luaBox}[showspaces]
for number in {1,2,3} do
    print(number)
end
\end{luaBox}

\subsection{Use space before and after binary operators}
All binary operators have to be pre- and succeeded by one space:

\conforming{}
\begin{cppBox}[showspaces]
cout << 1;
auto i = 0;
i += 2;
auto b = 3 * i;
\end{cppBox}
\begin{luaBox}[showspaces]
print("a" .. "b")
local i = 0
i = i + 2
local b = 3 * i
\end{luaBox}

\nonconforming{}
\begin{cppBox}[showspaces]
cout<<1;
auto i=0;
i +=2;
auto b =3*  i;
\end{cppBox}
\begin{luaBox}[showspaces]
print("a".."b")
local i =0
i =i+ 2
local b= 3  * i
\end{luaBox}

\subsection{Avoid space after function names}
This speaks for itself:

\conforming{}
\begin{cppBox}[showspaces]
std::move(object);
\end{cppBox}
\begin{luaBox}[showspaces]
print(1)
\end{luaBox}

\nonconforming{}
\begin{cppBox}[showspaces]
std::move (object);
\end{cppBox}
\begin{luaBox}[showspaces]
print (1)
\end{luaBox}

\subsection{Avoid trailing white space}
White space at the end of a line will produce strange diffs, so make sure you do not insert any:

\section{Use lower camel case for variable and function names}
Lower camel case means that the first letter of the first word is written in lower case while consecutive words are directly appended but start with upper case:

\conforming{}
\begin{cppBox}
int playerCounter;
Player destroyerOfWorlds;
void fooBar();
\end{cppBox}
\begin{luaBox}
local playerCounter
local robertOppenheimer

function fooBar()
end
\end{luaBox}

\nonconforming{}
\begin{cppBox}
int playercounter;
Player destroyer_Of_Worlds;
void foo_bar();
\end{cppBox}
\begin{luaBox}
local playercounter
local robert_Oppenheimer

function foo_bar()
end
\end{luaBox}


\section{Use upper camel case for class names}
Upper camel case means that a name consists of possibly multiple directly concatenated words, each starting with a capital letter:

\conforming{}
\begin{cppBox}
class PlayerManager
struct Position;
class SelectionDialog;
\end{cppBox}
\begin{luaBox}[mathescape]
PlayerCraft = {
    products = {},
    $\dots$
}
\end{luaBox}

\nonconforming{}
\begin{cppBox}
class playerManager
struct position;
class selection_dialog;
\end{cppBox}
\begin{luaBox}[mathescape]
player_craft = {
    products = {},
    $\dots$
}
\end{luaBox}

\section{Use proper British English}
It is important to use proper language as well as the proper language. Others will have to read what you write. Once we decided to use British English as official staff language, so this decision also applies to all written code. Small mistakes might and will happen, but that is no excuse to be lazy about it. Use a dictionary if you are not sure.

\section{Use block comments for license headers}
Using block comments for license headers at the beginning of each file allows editors to fold them, reducing the noise for you while you are working on actual code.


\chapter{Coding}
\section{Select expressive names}
Pick meaningful names. This is one of the most important aspects of good code. Do not use strange abbreviations. Variable names should describe their content, not an underlying data structure or implementation detail. Function names should describe an action for most functions and a question for boolean functions:

\conforming{}
\begin{cppBox}
int playerCounter;
std::vector<Player> players;

for (auto i = 0; i < 10; ++i); // i is a common name for counters

void savePlayers();
bool isYellow();
int getStrength();
\end{cppBox}
\begin{luaBox}
local playerCounter

for i = 1, 10 do -- i is a common name for counters
end

function useItem(user, item)
end
\end{luaBox}

\nonconforming{}
\begin{cppBox}
int plCtr;
std::vector<Player> playerVector;
void f();
\end{cppBox}
\begin{luaBox}
local plyCt

function calculate() -- calculate what?
end
\end{luaBox}

\section{Write only useful comments}
Express yourself in code instead of comments. Do not be redundant in comments. Do not use comments to rant or be otherwise unprofessional. One example for a good comment would be the description of a complex algorithm. You can cite the paper where you got it from and briefly express what the algorithm does. Another example would be documenting a function's precondition.

\nonconforming{}
\begin{cppBox}
int a = 0; // counts players
int playerCounter = 0; // set to 0

while (true) {
} // end while

int b = ++a + 2 - 3; // this code is shit!!!

// characterAge: the age of the characters
// returns the number of characters
int numberOfCharacters(int characterAge);
\end{cppBox}
\begin{luaBox}
local agility = 0 -- holds agility
local attribute = agility or 0 -- set attribute to agility or 0 if agility is nil

-- begin setting attributes
agility = 5
-- end setting attributes
\end{luaBox}

\section{Avoid deprecated code}
Deprecated code will create work when we decide to use a newer version of some language. Do not use it, there is no excuse. Others will have to replace that code in time. If you come across deprecated code, get rid of it.

You should be aware of what is marked as deprecated in the language version you are currently using.

\nonconforming{}
\begin{cppBox}
std::auto_ptr<Network>;
void save() throw();
~Player() throw();
\end{cppBox}
\begin{luaBox}
module("base.common", package.seeall)

length = table.maxn{4, 3, 2}
log = math.log10(1234)
\end{luaBox}

\conforming{}
\begin{cppBox}
std::unique_ptr<Network>;
void save() noexcept;
~Player();
\end{cppBox}
\begin{luaBox}[mathescape]
local M = {}
$\dots$
return M

length = #{4, 3, 2}
log = math.log(1234, 10)
\end{luaBox}

\section{Avoid duplicating code}
Do not duplicate code. Copy\&paste is bad. You or someone else will change that code in one place later and forget the other occurrences or not even know about them. Use functions if you need a piece of code more than once. Also use functions to clarify. If you can name it, you can put it into a function.

\section{Use libraries}
Prefer using language features or language libraries over reinventing the wheel. There is a reason those things exist. Your own code will just be inefficient, more verbose and may even contain bugs.

\section{Keep it as local as possible}
Keep the scope of variables as narrow as possible. The shorter their life span is, the less error-prone is your design.

\section{Write short, expressive functions}
Functions should be short and do one thing, specified by their name. If they are long and do things they are not supposed to do, it gets difficult to understand them or reason about them.

\section{Avoid unnecessary code and magic numbers}
Be precise in what you write. Write enough so that the code is clear and meaningful, but do not be verbose.

\nonconforming{}
\begin{cppBox}
return (player);
\end{cppBox}
\begin{luaBox}[mathescape]
a = 0; -- the ; is unnecessary in Lua, don't use it
i = (a * 3) + 2
local strength = getAttribute(5)

if (i == 4) then
    $\dots$
end

if true
    $\dots$
end
\end{luaBox}

\conforming{}
\begin{cppBox}
return player;
\end{cppBox}
\begin{luaBox}[mathescape]
a = 0
i = a * 3 + 2
local strength = getAttribute(Character.strength)

if i == 4 then
    $\dots$
end

do
    $\dots$
end
\end{luaBox}

\section{Refrain from using goto}
A form of the goto control statement exists in most languages. Do not use it.

\section{Use correct license headers}
Every user-written source file which runs on the server needs to be prefixed with the AGPLv3 header. This is true for everything we write in C++, Lua or PHP. Everything which will eventually run on a client machine needs to be prefixed with the GPLv3 header.

\end{document}
